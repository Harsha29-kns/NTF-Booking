<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Ticketing System - Complete Working Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px;
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
        }

        .content {
            padding: 60px;
        }

        .diagram-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 40px;
            margin: 30px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .mermaid {
            text-align: center;
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid #2196f3;
            padding: 25px;
            margin: 30px 0;
            border-radius: 10px;
            font-size: 1.1em;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .legend-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .legend-color {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            margin: 0 auto 10px;
        }

        .color-start {
            background: #3b82f6;
        }

        .color-blockchain {
            background: #8b5cf6;
        }

        .color-backend {
            background: #10b981;
        }

        .color-success {
            background: #f59e0b;
        }

        .color-error {
            background: #ef4444;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé´ NFT Ticketing System</h1>
            <p>Complete Working Flow - After MetaMask Connection</p>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>üìñ This flowchart shows the complete end-to-end process:</strong><br>
                From connecting MetaMask ‚Üí Registering ‚Üí Creating/Buying Tickets ‚Üí Downloading NFT ‚Üí Transferring ‚Üí
                Verification
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color color-start"></div>
                    <strong>User Actions</strong><br>
                    <small>Blue nodes</small>
                </div>
                <div class="legend-item">
                    <div class="legend-color color-blockchain"></div>
                    <strong>Blockchain</strong><br>
                    <small>Purple nodes</small>
                </div>
                <div class="legend-item">
                    <div class="legend-color color-backend"></div>
                    <strong>Backend/Database</strong><br>
                    <small>Green nodes</small>
                </div>
                <div class="legend-item">
                    <div class="legend-color color-success"></div>
                    <strong>Success States</strong><br>
                    <small>Orange nodes</small>
                </div>
                <div class="legend-item">
                    <div class="legend-color color-error"></div>
                    <strong>Error/Blocked</strong><br>
                    <small>Red nodes</small>
                </div>
            </div>

            <div class="diagram-container">
                <div class="mermaid">
                    graph TD
                    START([User Opens Website]) --> CONNECT[Connect MetaMask Wallet]

                    CONNECT --> WALLET_CONNECTED{Wallet<br />Connected?}
                    WALLET_CONNECTED -->|No| ERROR1[‚ùå Connection Failed]
                    WALLET_CONNECTED -->|Yes| CHECK_USER{User<br />Registered?}

                    CHECK_USER -->|No| REGISTER[Sign Up Process]
                    REGISTER --> SIGN_MSG[Sign Message with Wallet]
                    SIGN_MSG --> CREATE_ACCOUNT[Create Account in MongoDB]
                    CREATE_ACCOUNT --> JWT[Receive JWT Token]

                    CHECK_USER -->|Yes| AUTO_LOGIN[Auto Login with JWT]
                    JWT --> CHOOSE_ROLE{Choose Role}
                    AUTO_LOGIN --> CHOOSE_ROLE

                    CHOOSE_ROLE -->|Regular User| USER_PATH[USER PATH]
                    CHOOSE_ROLE -->|Organizer| ORG_PATH[ORGANIZER PATH]

                    %% ORGANIZER PATH
                    ORG_PATH --> CHECK_ORG{Approved<br />Organizer?}
                    CHECK_ORG -->|No| APPLY_ORG[Apply to Become Organizer]
                    APPLY_ORG --> WAIT_APPROVAL[Wait for Admin Approval]
                    CHECK_ORG -->|Yes| CREATE_EVENT[Create Event]
                    WAIT_APPROVAL --> CREATE_EVENT

                    CREATE_EVENT --> FILL_DETAILS["Fill Event Details:<br />Name, Date, Price, Tickets"]
                    FILL_DETAILS --> UPLOAD_IPFS[Upload Images to IPFS]
                    UPLOAD_IPFS --> GET_CID[Get IPFS CIDs]
                    GET_CID --> CALL_CONTRACT1[Call Smart Contract<br />createSale]

                    CALL_CONTRACT1 --> BLOCKCHAIN1["‚õìÔ∏è Blockchain:<br />‚Ä¢ Validate Data<br />‚Ä¢ Store Event<br />‚Ä¢ Emit
                    TicketCreated"]
                    BLOCKCHAIN1 --> INDEXER1[Event Indexer Detects]
                    INDEXER1 --> SAVE_DB1[Save Event to MongoDB]
                    SAVE_DB1 --> EVENT_LIVE([‚úÖ Event Live!])

                    EVENT_LIVE --> MANAGE_EVENT["Organizer Can:<br />‚Ä¢ View Analytics<br />‚Ä¢ Approve Transfers<br />‚Ä¢
                    Manage Tickets"]

                    %% USER PATH
                    USER_PATH --> BROWSE[Browse Available Events]
                    BROWSE --> SELECT_EVENT[Select Event]
                    SELECT_EVENT --> VIEW_DETAILS[View Event Details]

                    VIEW_DETAILS --> CHECK_OWNED{Already Own<br />Ticket?}
                    CHECK_OWNED -->|Yes| BLOCKED1[‚ùå 1 Ticket Per Wallet]
                    CHECK_OWNED -->|No| BUY_TICKET[Click Buy Ticket]

                    BUY_TICKET --> METAMASK_TX[MetaMask Transaction Popup]
                    METAMASK_TX --> CONFIRM{Confirm<br />Payment?}
                    CONFIRM -->|No| CANCEL[Purchase Cancelled]

                    CONFIRM -->|Yes| BLOCKCHAIN2["‚õìÔ∏è Blockchain:<br />‚Ä¢ Verify Payment<br />‚Ä¢ Check Availability<br />‚Ä¢
                    Transfer ETH to Organizer<br />‚Ä¢ Create Ticket Instance<br />‚Ä¢ Mark User as Holder"]

                    BLOCKCHAIN2 --> TX_SUCCESS{Success?}
                    TX_SUCCESS -->|No| ERROR2[‚ùå Transaction Failed]
                    TX_SUCCESS -->|Yes| INDEXER2[Event Indexer Syncs]

                    INDEXER2 --> SAVE_DB2[Update MongoDB Purchase]
                    SAVE_DB2 --> PURCHASE_DONE([‚úÖ Purchase Complete!])

                    PURCHASE_DONE --> MY_TICKETS[Go to My Tickets]
                    MY_TICKETS --> VIEW_TICKET[View Purchased Ticket]

                    VIEW_TICKET --> CHECK_DOWNLOADED{NFT Already<br />Downloaded?}
                    CHECK_DOWNLOADED -->|Yes| SHOW_TICKET[Display Ticket with QR]
                    CHECK_DOWNLOADED -->|No| DOWNLOAD_BTN[Click Download Ticket]

                    DOWNLOAD_BTN --> CALL_CONTRACT2[Call Smart Contract<br />downloadTicket]
                    CALL_CONTRACT2 --> BLOCKCHAIN3["‚õìÔ∏è Blockchain:<br />‚Ä¢ Verify Ownership<br />‚Ä¢ Mint ERC721 NFT<br />‚Ä¢
                    Mark as Downloaded"]

                    BLOCKCHAIN3 --> INDEXER3[Event Indexer Syncs]
                    INDEXER3 --> SAVE_DB3[Update MongoDB Status]
                    SAVE_DB3 --> GENERATE_QR[Generate QR Code]
                    GENERATE_QR --> SHOW_TICKET

                    SHOW_TICKET --> TICKET_ACTIONS{What to Do?}

                    TICKET_ACTIONS -->|Print| PRINT[Print Ticket]
                    TICKET_ACTIONS -->|Transfer| TRANSFER_REQ[Request Transfer]
                    TICKET_ACTIONS -->|Verify| VERIFY_FLOW[Verify Ticket]

                    %% TRANSFER FLOW
                    TRANSFER_REQ --> FILL_TRANSFER["Fill Transfer Form:<br />Recipient Address"]
                    FILL_TRANSFER --> SUBMIT_TRANSFER[Submit to Backend]
                    SUBMIT_TRANSFER --> SAVE_DB4[Save Request to MongoDB]
                    SAVE_DB4 --> NOTIFY_ORG[Notify Organizer]

                    NOTIFY_ORG --> ORG_DECISION{Organizer<br />Approves?}
                    ORG_DECISION -->|No| REJECT[‚ùå Transfer Rejected]
                    ORG_DECISION -->|Yes| CHECK_SECOND{Already<br />Transferred?}

                    CHECK_SECOND -->|Yes| BLOCKED2[‚ùå One-Time Transfer Policy]
                    CHECK_SECOND -->|No| CHECK_RECIPIENT{Recipient<br />Has Ticket?}

                    CHECK_RECIPIENT -->|Yes| BLOCKED3[‚ùå Recipient Already Owns]
                    CHECK_RECIPIENT -->|No| EXECUTE_TRANSFER[Organizer Calls<br />adminTransferTicket]

                    EXECUTE_TRANSFER --> BLOCKCHAIN4["‚õìÔ∏è Blockchain:<br />‚Ä¢ Remove from Sender<br />‚Ä¢ Add to
                    Recipient<br />‚Ä¢ Mark as Second Hand<br />‚Ä¢ Transfer NFT"]

                    BLOCKCHAIN4 --> INDEXER4[Event Indexer Syncs]
                    INDEXER4 --> SAVE_DB5[Update MongoDB Ownership]
                    SAVE_DB5 --> TRANSFER_DONE([‚úÖ Transfer Complete!])

                    TRANSFER_DONE --> NEW_OWNER["New Owner:<br />‚Ä¢ Can Download NFT<br />‚Ä¢ Cannot Transfer Again"]
                    TRANSFER_DONE --> OLD_OWNER["Old Owner:<br />‚Ä¢ Loses Ticket<br />‚Ä¢ Can Buy Again"]

                    %% VERIFY FLOW
                    VERIFY_FLOW --> SCAN_QR[Scan QR Code]
                    SCAN_QR --> GET_TICKET_ID[Extract Ticket ID]
                    GET_TICKET_ID --> CALL_VERIFY[Call Smart Contract<br />verifyTicket]

                    CALL_VERIFY --> BLOCKCHAIN5["‚õìÔ∏è Blockchain:<br />‚Ä¢ Check Exists<br />‚Ä¢ Check Downloaded<br />‚Ä¢ Check
                    Not Refunded<br />‚Ä¢ Verify Ownership"]

                    BLOCKCHAIN5 --> VALID{Valid?}
                    VALID -->|No| INVALID[‚ùå Invalid Ticket]
                    VALID -->|Yes| SHOW_INFO["‚úÖ Valid Ticket!<br />Show Event Info"]

                    SHOW_INFO --> ADMIN_CHECK{Admin<br />Verification?}
                    ADMIN_CHECK -->|Yes| MARK_USED[Mark as Used in DB]
                    ADMIN_CHECK -->|No| VERIFY_DONE([Verification Complete])
                    MARK_USED --> VERIFY_DONE

                    %% Styling
                    style START fill:#3b82f6,color:#fff
                    style CONNECT fill:#3b82f6,color:#fff
                    style BLOCKCHAIN1 fill:#8b5cf6,color:#fff
                    style BLOCKCHAIN2 fill:#8b5cf6,color:#fff
                    style BLOCKCHAIN3 fill:#8b5cf6,color:#fff
                    style BLOCKCHAIN4 fill:#8b5cf6,color:#fff
                    style BLOCKCHAIN5 fill:#8b5cf6,color:#fff
                    style SAVE_DB1 fill:#10b981,color:#fff
                    style SAVE_DB2 fill:#10b981,color:#fff
                    style SAVE_DB3 fill:#10b981,color:#fff
                    style SAVE_DB4 fill:#10b981,color:#fff
                    style SAVE_DB5 fill:#10b981,color:#fff
                    style INDEXER1 fill:#10b981,color:#fff
                    style INDEXER2 fill:#10b981,color:#fff
                    style INDEXER3 fill:#10b981,color:#fff
                    style INDEXER4 fill:#10b981,color:#fff
                    style EVENT_LIVE fill:#f59e0b,color:#fff
                    style PURCHASE_DONE fill:#f59e0b,color:#fff
                    style TRANSFER_DONE fill:#f59e0b,color:#fff
                    style VERIFY_DONE fill:#f59e0b,color:#fff
                    style ERROR1 fill:#ef4444,color:#fff
                    style ERROR2 fill:#ef4444,color:#fff
                    style BLOCKED1 fill:#ef4444,color:#fff
                    style BLOCKED2 fill:#ef4444,color:#fff
                    style BLOCKED3 fill:#ef4444,color:#fff
                    style INVALID fill:#ef4444,color:#fff
                    style SHOW_INFO fill:#10b981,color:#fff
                </div>
            </div>

            <div class="info-box" style="margin-top: 40px;">
                <strong>üîë Key Points:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li><strong>MetaMask Connection</strong> - Required for all blockchain interactions</li>
                    <li><strong>Smart Contract</strong> - All ticket operations happen on-chain (purple nodes)</li>
                    <li><strong>Event Indexer</strong> - Automatically syncs blockchain events to MongoDB</li>
                    <li><strong>One Ticket Per Wallet</strong> - Enforced by smart contract</li>
                    <li><strong>One-Time Transfer</strong> - Tickets can only be transferred once</li>
                    <li><strong>NFT Ownership</strong> - Users truly own their tickets as ERC721 tokens</li>
                    <li><strong>QR Verification</strong> - Tickets verified against blockchain state</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            }
        });
    </script>
</body>

</html>